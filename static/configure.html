<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
    crossorigin="anonymous"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.8/jquery.min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/list.js/1.5.0/list.min.js"></script>
</head>

<style>
  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  }

  table td,
  table th {
    font-size: 120%;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    padding: 5px;
  }

  .footer {
    position: fixed;
    left: 0;
    bottom: 0;
    width: 100%;
    padding-top: 10px;
    background-color: #ffbb22;
    color: black;
    text-align: center;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  }
</style>


<div class="table-responsive" style="margin-top: 2em; margin-left: 10%;margin-right: 10%;" id="contacts">
  <table>
    <td class="buildingId">
      <input type="hidden" id="id-field" />
      <input class="form-control input-sm" type="text" id="buildingId-field" placeholder="Building Id" />
    </td>
    <td class="flatId">
      <input class="form-control input-sm" type="text" id="flatId-field" placeholder="Flat Id" />
    </td>
    <td class="ledId">
      <input class="form-control input-sm" type="text" id="ledId-field" placeholder="Led Id" />
    </td>
    <td class="add">
      <button type="button" class="btn btn-success" id="add-btn">Add</button>
      <button id="edit-btn">Edit</button>
    </td>
    <td>        </td>
    <td class="ledTestId">
        <input class="form-control input-sm" type="text" id="ledTestId-field" placeholder="[TEST] Led Id" />
      </td>
      <td class="on">
        <button type="button" class="btn btn-primary" id="on-btn">ON</button>
      </td>
      <td class="off">
        <button type="button" class="btn btn-primary" id="off-btn">OFF</button>
      </td>
  </table>
  <table>
  
  </table>
  <table class="table table-striped table-hover table-condensed">
    <thead>
      <tr>
        <th class="sort" data-sort="buildingId">Building Id</th>
        <th class="sort" data-sort="flatId">Flat Id</th>
        <th class="sort" data-sort="ledId">Led Id</th>
        <th colspan="2">
          <input type="text" class="search form-control input-sm" placeholder="Search" />
        </th>
      </tr>
    </thead>
    <tbody class="list">
      <tr id="999999">
        <td class="id" style="display: none;">999999</td>
        <td class="buildingId">1</td>
        </b>
        <td class="flatId">1</td>
        <td class="ledId">2</td>
        <td class="edit">
          <button class="btn btn-warning" style="display: none;">Edit</button>
        </td>
        <td class="remove">
          <button class="btn btn-danger">Remove</button>
        </td>
      </tr>

    </tbody>
  </table>


  <!-- Footer -->
  <div class="footer">
    <p>
      <b>Copyright@2018 - PATYO Mimarlik Ankara/TURKEY</b>
    </p>
  </div>

</div>

<body>
  <!--SOCKET.IO !-->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.0.4/socket.io.js"></script>

  <script>
    var options = {
      valueNames: ['id', 'buildingId', 'flatId', 'ledId']
    };

    // Init list
    var contactList = new List('contacts', options);

    var idField = $('#id-field'),
      buildingIdField = $('#buildingId-field'),
      flatIdField = $('#flatId-field'),
      ledIdField = $('#ledId-field'),
      addBtn = $('#add-btn'),
      testLedId = $('#ledTestId-field'),
      onBtn = $('#on-btn'),
      offBtn = $('#off-btn'),
      editBtn = $('#edit-btn').hide(),
      removeBtns = $('.btn-danger'),
      editBtns = $('.btn-warning');

    // Sets callbacks to the buttons in the list
    refreshCallbacks();

    //Add button
    addBtn.click(function () {
      socket.emit('led_add', {
        buildingId: buildingIdField.val().trim(),
        flatId: flatIdField.val().trim(),
        ledId: ledIdField.val().trim()
      });
    });

    onBtn.click(function () {
      socket.emit('led_test_on',testLedId.val());
    });

    offBtn.click(function () {
      socket.emit('led_test_off',testLedId.val());
    });
    //Edit button
    editBtn.click(function () {
      var item = contactList.get('id', idField.val())[0];
      item.values({
        id: idField.val(),
        buildingId: buildingIdField.val(),
        flatId: flatIdField.val(),
        ledId: ledIdField.val()
      });
      clearFields();
      editBtn.hide();
      addBtn.show();
    });

    // Needed to add new buttons to jQuery-extended object
    function refreshCallbacks() {
      removeBtns = $(removeBtns.selector);
      editBtns = $(editBtns.selector);

      removeBtns.click(function () {
        var itemId = $(this).closest('tr').find('.id').text();
        var list_item;
        contactList.items.forEach(element => {
          if (String(element._values.id) == itemId) {
            list_item = element._values;
            console.log(element._values.ledId);
          }
        });
        console.log(contactList.items);
        contactList.remove('id', itemId);
        socket.emit('led_remove', {
          buildingId: list_item.buildingId,
          flatId: list_item.flatId,
          ledId: list_item.ledId
        });
        //location.reload();
      });

      editBtns.click(function () {
        var itemId = $(this).closest('tr').find('.id').text();
        var itemValues = contactList.get('id', itemId)[0].values();
        idField.val(itemValues.id);
        buildingIdField.val(itemValues.buildingId);
        flatIdField.val(itemValues.flatId);
        ledIdField.val(itemValues.ledId);

        editBtn.show();
        addBtn.hide();
      });
    }

    function clearFields() {
      buildingIdField.val('');
      flatIdField.val('');
      ledIdField.val('');
    }

    function showWrongDataPopupMessage() {
      alert("Please enter valid values to the fields !")
    }

    function showAlreadyOnTheListPopupMessage(data) {
      console.log(data);
      try {
        alert("LedId is already in use ! \nBuildingId = " + data.buildingId + " \nFlatId = " + data.flatId);        
      } catch (error) {
        alert("LedId value is incorrect !");
      }
    }
  </script>


  <!--AJAX + JS SCRIPT  For Socket.io!-->
  <script>
    var socket = io('http://192.168.1.28:8484');
    var server_address = "http://192.168.1.28:8484"

    //When data arrives on socket.io
    socket.on('data', function (data) {
      console.log("DATA FROM SOCKET");
      console.log(data);
      $("#text").append(data);
    });

    socket.on('error_led_id_exists_or_not_int', function (data) {
      showAlreadyOnTheListPopupMessage(data);
    });

    socket.on('add_led_success', function (data) {
      contactList.add({
        id: ledIdField.val(),
        buildingId: buildingIdField.val(),
        flatId: flatIdField.val(),
        ledId: ledIdField.val()
      });
      clearFields();
      refreshCallbacks();
      location.reload();
    });

    socket.on('dbValues', function (data) {
      console.log(data);
      var result_style = document.getElementById('999999').style;
      result_style.display = 'none';
      data.forEach(element => {
        contactList.add({
          id: element["ledId"],
          buildingId: element["buildingId"],
          flatId: element["flatId"],
          ledId: element["ledId"]
        });
      });
      clearFields();
      refreshCallbacks();
    });
  </script>
</body>