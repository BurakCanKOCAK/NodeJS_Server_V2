<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
    crossorigin="anonymous"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.8/jquery.min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/list.js/1.5.0/list.min.js"></script>
</head>

<style>
  body {
    font-family: sans-serif;
  }

  table td,
  table th {
    padding: 5px;
  }
</style>


<div class="table-responsive" id="contacts">
  <table>
    <td class="buildingId">
      <input type="hidden" id="id-field" />
      <input class="form-control input-sm" type="text" id="buildingId-field" placeholder="Building Id" />
    </td>
    <td class="flatId">
      <input class="form-control input-sm" type="text" id="flatId-field" placeholder="Flat Id" />
    </td>
    <td class="ledId">
      <input class="form-control input-sm" type="text" id="ledId-field" placeholder="Led Id" />
    </td>
    <td class="add">
      <button id="add-btn">Add</button>
      <button id="edit-btn">Edit</button>
    </td>
  </table>
  <table class="table table-striped table-hover table-condensed">
    <thead>
      <tr>
        <th class="sort" data-sort="buildingId">Building Id</th>
        <th class="sort" data-sort="flatId">Flat Id</th>
        <th class="sort" data-sort="ledId">Led Id</th>
        <th colspan="2">
          <input type="text" class="search form-control input-sm" placeholder="Search" />
        </th>
      </tr>
    </thead>
    <tbody class="list">
      <tr>
        <td class="id" style="display:none;">999999</td>
        <td class="buildingId">Test</td>
        <td class="flatId">Test</td>
        <td class="ledId">1</td>
        <td class="edit">
          <button class="btn btn-warning">Edit</button>
        </td>
        <td class="remove">
          <button class="btn btn-danger">Remove</button>
        </td>
      </tr>
      <tr>
        <td class="id" style="display:none;">999998</td>
        <td class="buildingId">1</td>
        <td class="flatId">1</td>
        <td class="ledId">1</td>
        <td class="edit">
          <button class="btn btn-warning">Edit</button>
        </td>
        <td class="remove">
          <button class="btn btn-danger">Remove</button>
        </td>
      </tr>
    
    </tbody>
  </table>


  <p>Copyright@BBH 2018</p>
</div>

<body>
  <!--SOCKET.IO !-->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.0.4/socket.io.js"></script>

  <script>
    var options = {
      valueNames: ['id', 'buildingId', 'flatId', 'ledId']
    };

    // Init list
    var contactList = new List('contacts', options);

    var idField = $('#id-field'),
    buildingIdField = $('#buildingId-field'),
    flatIdField = $('#flatId-field'),
    ledIdField = $('#ledId-field'),
      addBtn = $('#add-btn'),
      editBtn = $('#edit-btn').hide(),
      removeBtns = $('.btn-danger'),
      editBtns = $('.btn-warning');

    // Sets callbacks to the buttons in the list
    refreshCallbacks();

    //Add button
    addBtn.click(function () {
      contactList.add({
        id: ledIdField.val(),
        buildingId: buildingIdField.val(),
        flatId: flatIdField.val(),
        ledId: ledIdField.val()
      });
      socket.emit('led_add', { buildingId : buildingIdField.val().trim(),flatId:flatIdField.val().trim(),ledId:ledIdField.val().trim() });
      clearFields();
      refreshCallbacks();
      location.reload();
    });
    
    //Edit button
    editBtn.click(function () {
      var item = contactList.get('id', idField.val())[0];
      item.values({
        id: idField.val(),
        buildingId: buildingIdField.val(),
        flatId: flatIdField.val(),
        ledId: ledIdField.val()
      });
      clearFields();
      editBtn.hide();
      addBtn.show();
    });

    // Needed to add new buttons to jQuery-extended object
    function refreshCallbacks() {
      removeBtns = $(removeBtns.selector);
      editBtns = $(editBtns.selector);

      removeBtns.click(function () {
        var itemId = $(this).closest('tr').find('.id').text();
        var list_item;
        contactList.items.forEach(element => {
          if(String(element._values.id)==itemId)
          {
            list_item=element._values;
            console.log(element._values.ledId);
          }
        });
        console.log(contactList.items);
        contactList.remove('id', itemId);
        socket.emit('led_remove', { buildingId : list_item.buildingId,flatId:list_item.flatId,ledId:list_item.ledId});
        location.reload();
      });

      editBtns.click(function () {
        var itemId = $(this).closest('tr').find('.id').text();
        var itemValues = contactList.get('id', itemId)[0].values();
        idField.val(itemValues.id);
        buildingIdField.val(itemValues.buildingId);
        flatIdField.val(itemValues.flatId);
        ledIdField.val(itemValues.ledId);

        editBtn.show();
        addBtn.hide();
      });
    }

    function clearFields() {
      buildingIdField.val('');
      flatIdField.val('');
      ledIdField.val('');
    }

    function showWrongDataPopupMessage(){
      alert("Please enter valid values to the fields !")
    }
    function showAlreadyOnTheListPopupMessage(){
      alert("LedId is already in use !")
    }

</script>


  <!--AJAX + JS SCRIPT  For Socket.io!-->
  <script>
    var socket = io('http://127.0.0.1:8484');
    var server_address = "http://127.0.0.1:8484"

    //When data arrives on socket.io
    socket.on('data', function (data) {
      console.log("DATA FROM SOCKET");
      console.log(data);
      $("#text").append(data);
    });

    socket.on('dbValues', function (data) {
      console.log(data);
      data.forEach(element => {
        contactList.add({
        id: element["ledId"],
        buildingId: element["buildingId"],
        flatId: element["flatId"],
        ledId: element["ledId"]
        });
      });
      contactList.remove('id', 999999);
      clearFields();
      refreshCallbacks();
    });

  </script>
</body>